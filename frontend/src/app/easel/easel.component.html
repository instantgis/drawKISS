<div class="easel-container">

  <!-- Toolbar -->
  <div class="toolbar">
    <button class="btn btn-secondary" (click)="goBack()">‚Üê Gallery</button>

    <input
      class="toolbar-title-input"
      [value]="imageTitle()"
      (blur)="updateTitle($any($event.target).value)"
      (keydown.enter)="$any($event.target).blur()"
      placeholder="Image title..." />

    <div class="toolbar-group">
      <label>Rows: {{ gridRows() }}</label>
      <input type="range" min="2" max="20" [value]="gridRows()"
             (input)="gridRows.set(+$any($event.target).value)" />
    </div>

    <div class="toolbar-group">
      <label>Cols: {{ gridCols() }}</label>
      <input type="range" min="2" max="20" [value]="gridCols()"
             (input)="gridCols.set(+$any($event.target).value)" />
    </div>

    <button class="btn btn-secondary" (click)="saveGridSettings()" title="Save grid settings">
      üíæ Save Grid
    </button>

    <div class="toolbar-group">
      <app-category-picker
        [selectedId]="selectedCategory()"
        (selectedChange)="updateCategory($event)" />
    </div>

    <button class="btn btn-secondary" (click)="toggleGrid()">
      {{ showGrid() ? 'Hide Grid' : 'Show Grid' }}
    </button>

    @if (selectedCell()) {
      <button class="btn btn-secondary" (click)="clearSelection()">Clear Focus</button>
    }

    <div class="toolbar-divider"></div>

    <!-- Zoom controls -->
    <div class="toolbar-group zoom-controls">
      <button class="btn btn-icon" (click)="zoomOut()" title="Zoom Out">‚àí</button>
      <span class="zoom-level">{{ (zoom() * 100).toFixed(0) }}%</span>
      <button class="btn btn-icon" (click)="zoomIn()" title="Zoom In">+</button>
      <button class="btn btn-icon" (click)="resetZoom()" title="Reset Zoom">‚ü≤</button>
    </div>

    <button class="btn btn-secondary" (click)="toggleFullscreen()" title="Toggle Fullscreen">
      {{ isFullscreen() ? '‚õ∂' : '‚õ∂' }}
    </button>

    @if (selectedLayerId()) {
      <button class="btn btn-danger btn-icon" (click)="deleteSelectedLayer()" title="Delete selected layer">
        üóë
      </button>
    }
  </div>

  <!-- Layer selector -->
  @if (layers().length > 0) {
    <div class="layer-bar">
      <button
        class="layer-chip"
        [class.active]="selectedLayerId() === null"
        (click)="showRawImage()">
        Original
      </button>
      @for (layer of layers(); track layer.id) {
        <button
          class="layer-chip"
          [class.active]="selectedLayerId() === layer.id"
          (click)="selectLayer(layer.id)">
          {{ layer.name ?? 'Layer' }}
        </button>
      }
    </div>
  }

  <!-- Main canvas area -->
  <div class="canvas-area"
       (wheel)="onWheel($event)"
       (mousedown)="onPanStart($event)"
       (mousemove)="onPanMove($event)"
       (mouseup)="onPanEnd()"
       (mouseleave)="onPanEnd()"
       (touchstart)="onPanStart($event)"
       (touchmove)="onPanMove($event)"
       (touchend)="onPanEnd()"
       [class.panning]="isPanning()">
    @if (error()) {
      <div class="error-overlay">
        <p>{{ error() }}</p>
      </div>
    }

    <div class="zoom-container"
         [style.transform]="'scale(' + zoom() + ') translate(' + panX() + 'px, ' + panY() + 'px)'">
      @if (imageUrl()) {
        <img [src]="imageUrl()" alt="Sketch reference" class="reference-image" />
      } @else {
        <div class="placeholder">
          <p>No image loaded</p>
          <p class="hint">Take a photo from the Capture page</p>
        </div>
      }

      <!-- SVG Grid Overlay -->
      @if (showGrid()) {
        <svg class="grid-overlay" viewBox="0 0 100 100" preserveAspectRatio="none">
        <!-- Clickable cells -->
        @for (cell of cells(); track cell.row + '-' + cell.col) {
          <rect
            [attr.x]="cell.x"
            [attr.y]="cell.y"
            [attr.width]="cell.width"
            [attr.height]="cell.height"
            class="grid-cell"
            [class.dimmed]="isCellDimmed(cell.row, cell.col)"
            (click)="selectCell(cell.row, cell.col)"
          />
        }

        <!-- Grid lines - dark outline -->
        @for (line of gridLines(); track 'o-' + line.x1 + '-' + line.y1) {
          <line
            [attr.x1]="line.x1 + '%'"
            [attr.y1]="line.y1 + '%'"
            [attr.x2]="line.x2 + '%'"
            [attr.y2]="line.y2 + '%'"
            class="grid-line"
          />
        }
        <!-- Grid lines - yellow inner -->
        @for (line of gridLines(); track 'i-' + line.x1 + '-' + line.y1) {
          <line
            [attr.x1]="line.x1 + '%'"
            [attr.y1]="line.y1 + '%'"
            [attr.x2]="line.x2 + '%'"
            [attr.y2]="line.y2 + '%'"
            class="grid-line-inner"
          />
        }
        </svg>
      }
    </div>
  </div>

</div>

