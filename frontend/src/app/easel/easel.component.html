<div class="easel-container">

  <!-- Minimal top bar -->
  <div class="top-bar">
    <button class="btn-float" (click)="goBack()" title="Back to Gallery">‚Üê</button>
    <input
      class="title-input"
      [value]="imageTitle()"
      (blur)="updateTitle($any($event.target).value)"
      (keydown.enter)="$any($event.target).blur()"
      placeholder="Untitled..." />
    <button class="btn-float" (click)="toggleFullscreen()" title="Toggle Fullscreen">‚õ∂</button>
  </div>

  <!-- Full-screen canvas area -->
  <div class="canvas-area"
       (wheel)="onWheel($event)"
       (mousedown)="onPanStart($event)"
       (mousemove)="onPanMove($event)"
       (mouseup)="onPanEnd()"
       (mouseleave)="onPanEnd()"
       (touchstart)="onTouchStart($event)"
       (touchmove)="onTouchMove($event)"
       (touchend)="onPanEnd()"
       [class.panning]="isPanning()">

    @if (error()) {
      <div class="error-overlay">
        <p>{{ error() }}</p>
      </div>
    }

    @if (layerLoading()) {
      <div class="loading-overlay">
        <div class="spinner"></div>
      </div>
    }

    <div class="zoom-container"
         [style.transform]="'scale(' + zoom() + ') translate(' + panX() + 'px, ' + panY() + 'px)'">
      @if (imageUrl()) {
        <img [src]="imageUrl()" alt="Sketch reference" class="reference-image" (load)="onImageLoaded()" />
      } @else {
        <div class="placeholder">
          <p>No image loaded</p>
          <p class="hint">Take a photo from the Capture page</p>
        </div>
      }

      <!-- SVG Grid Overlay -->
      @if (showGrid()) {
        <svg class="grid-overlay" viewBox="0 0 100 100" preserveAspectRatio="none">
          @for (cell of cells(); track cell.row + '-' + cell.col) {
            <rect
              [attr.x]="cell.x"
              [attr.y]="cell.y"
              [attr.width]="cell.width"
              [attr.height]="cell.height"
              class="grid-cell"
              [class.dimmed]="isCellDimmed(cell.row, cell.col)"
              (click)="selectCell(cell.row, cell.col)"
            />
          }
          @for (line of gridLines(); track $index) {
            <line
              [attr.x1]="line.x1 + '%'" [attr.y1]="line.y1 + '%'"
              [attr.x2]="line.x2 + '%'" [attr.y2]="line.y2 + '%'"
              class="grid-line"
            />
            <line
              [attr.x1]="line.x1 + '%'" [attr.y1]="line.y1 + '%'"
              [attr.x2]="line.x2 + '%'" [attr.y2]="line.y2 + '%'"
              class="grid-line-inner"
            />
          }
        </svg>
      }
    </div>
  </div>

  <!-- Toggle button - always visible at bottom -->
  <button class="drawer-toggle" (click)="toggleDrawer()">
    {{ drawerOpen() ? '‚ñº' : '‚ñ≤' }}
  </button>

  <!-- Bottom drawer panel -->
  <div class="bottom-drawer" [class.closed]="!drawerOpen()">
    <div class="drawer-content">
      <!-- Layer chips -->
      <div class="drawer-section">
        <div class="layer-chips">
          <button
            class="layer-chip"
            [class.active]="selectedLayerId() === null"
            (click)="showRawImage()">
            Original
          </button>
          @for (layer of layers(); track layer.id) {
            <button
              class="layer-chip"
              [class.active]="selectedLayerId() === layer.id"
              (click)="selectLayer(layer.id)">
              {{ layer.name ?? 'Layer' }}
            </button>
          }
        </div>
      </div>

      <!-- Quick actions row -->
      <div class="drawer-section action-row">
        <button class="btn-action" (click)="toggleGrid()" [class.active]="showGrid()">
          <span class="icon">‚ñ¶</span>
          <span class="label">Grid</span>
        </button>
        @if (selectedCell()) {
          <button class="btn-action" (click)="clearSelection()">
            <span class="icon">‚úï</span>
            <span class="label">Clear</span>
          </button>
        }
        <button class="btn-action" (click)="resetZoom()">
          <span class="icon">‚ü≤</span>
          <span class="label">Reset</span>
        </button>
        @if (selectedLayerId()) {
          <button class="btn-action danger" (click)="deleteSelectedLayer()">
            <span class="icon">üóë</span>
            <span class="label">Delete</span>
          </button>
        }
      </div>

      <!-- Grid controls -->
      <div class="drawer-section grid-controls">
        <div class="control-group">
          <label>Rows</label>
          <div class="stepper">
            <button (click)="adjustGrid('rows', -1)">‚àí</button>
            <span>{{ gridRows() }}</span>
            <button (click)="adjustGrid('rows', 1)">+</button>
          </div>
        </div>
        <div class="control-group">
          <label>Cols</label>
          <div class="stepper">
            <button (click)="adjustGrid('cols', -1)">‚àí</button>
            <span>{{ gridCols() }}</span>
            <button (click)="adjustGrid('cols', 1)">+</button>
          </div>
        </div>
        <button class="btn-save" (click)="saveGridSettings()">üíæ Save</button>
      </div>

      <!-- Category picker -->
      <div class="drawer-section">
        <app-category-picker
          [selectedId]="selectedCategory()"
          (selectedChange)="updateCategory($event)" />
      </div>
    </div>
  </div>

</div>

