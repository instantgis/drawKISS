<div class="capture-container">

  <!-- Messages -->
  @if (error()) {
    <div class="message-banner error">{{ error() }}</div>
  }
  @if (successMessage()) {
    <div class="message-banner success">{{ successMessage() }}</div>
  }

  <canvas #canvasEl class="hidden"></canvas>

  <!-- ========== CAPTURE MODE ========== -->
  @if (mode() === 'capture') {
    <div class="media-frame camera-frame">
      @if (!cameraActive()) {
        <p class="placeholder-text">Camera preview will appear here</p>
      }
      <video #videoEl [class.hidden]="!cameraActive()" autoplay playsinline muted></video>

      <!-- Camera controls overlay -->
      @if (cameraActive()) {
        <div class="camera-controls">
          @if (cameraCapabilities().brightness) {
            <div class="control-group">
              <button class="control-btn" (click)="adjustBrightness(-1)" title="Darker">‚àí</button>
              <span class="control-icon">üîÜ</span>
              <button class="control-btn" (click)="adjustBrightness(1)" title="Brighter">+</button>
            </div>
          }
          @if (cameraCapabilities().zoom) {
            <div class="control-group">
              <button class="control-btn" (click)="adjustZoom(-1)" title="Zoom out">‚àí</button>
              <span class="control-icon">üîç</span>
              <button class="control-btn" (click)="adjustZoom(1)" title="Zoom in">+</button>
            </div>
          }
        </div>
      }
    </div>

    <div class="controls">
      @if (!cameraActive()) {
        <button class="btn btn-primary btn-lg" (click)="startCamera()">Start Camera</button>
      } @else {
        <button class="btn btn-primary" (click)="capture()" [disabled]="processing()">üì∑ Capture</button>
        <button class="btn btn-secondary" (click)="stopCamera()">Stop</button>
      }
    </div>
  }

  <!-- ========== EDIT MODE ========== -->
  @if (mode() === 'edit') {
    <div class="edit-layout">
      <!-- Left: Raw image preview -->
      <div class="raw-panel">
        <h2>Raw Capture</h2>
        <div class="media-frame small">
          <img [src]="rawImageUrl()" alt="Raw capture" />
        </div>

        <!-- Title input -->
        <div class="title-input">
          <label for="imageTitle">Title</label>
          <input
            id="imageTitle"
            type="text"
            [ngModel]="imageTitle()"
            (ngModelChange)="imageTitle.set($event)"
            placeholder="Enter image title..."
            [disabled]="isImageSaved()" />
        </div>

        <!-- Category picker -->
        @if (!isImageSaved()) {
          <div class="category-input">
            <label>Category</label>
            <app-category-picker
              [selectedId]="selectedCategory()"
              (selectedChange)="selectedCategory.set($event)" />
          </div>
        }

        <!-- Save raw or status -->
        @if (!isImageSaved()) {
          <div class="action-row">
            <button class="btn btn-primary" (click)="saveRawImage()" [disabled]="processing()">
              @if (processing()) {
                <span class="spinner"></span> Saving...
              } @else {
                Save to Gallery
              }
            </button>
            <button class="btn btn-danger" (click)="discard()">Discard</button>
          </div>
        } @else {
          <div class="saved-status">
            Saved: {{ savedImage()?.title }}
          </div>
          <div class="action-row">
            <button class="btn btn-secondary" (click)="discard()">New Capture</button>
          </div>
        }
      </div>

      <!-- Right: Layer editor -->
      <div class="layer-panel">
        <h2>Add Layers</h2>

        @if (!isImageSaved()) {
          <p class="hint">Save the image first to add layers</p>
        } @else {
          <!-- Filter controls -->
          <div class="option-group">
            <label>Filter</label>
            <select [value]="layerType()" (change)="setLayerType($any($event.target).value)">
              @for (type of layerTypes; track type) {
                <option [value]="type">{{ formatLayerType(type) }}</option>
              }
            </select>
          </div>

          @if (hasParams()) {
            <div class="option-group">
              <label>{{ getParamRange().label }}: {{ paramValue() }}</label>
              <input type="range"
                     [min]="getParamRange().min"
                     [max]="getParamRange().max"
                     [value]="paramValue()"
                     (input)="setParamValue(+$any($event.target).value)" />
            </div>
          }

          <!-- Preview & Save buttons -->
          <div class="action-row">
            <button class="btn btn-secondary" (click)="processImage()" [disabled]="processing()">
              @if (processing()) {
                <span class="spinner"></span> Processing...
              } @else {
                Preview
              }
            </button>
            <button class="btn btn-primary" (click)="addLayer()" [disabled]="processing() || !processedImageUrl() || layerSaved()">
              @if (layerSaved()) {
                ‚úì Saved
              } @else {
                Save Layer
              }
            </button>
          </div>

          <!-- Layer preview -->
          @if (processedImageUrl()) {
            <div class="media-frame small">
              <img [src]="processedImageUrl()" alt="Layer preview" />
            </div>
          }

          <!-- Saved layers list -->
          @if (savedLayers().length > 0) {
            <div class="saved-layers">
              <h3>Saved Layers ({{ savedLayers().length }})</h3>
              <ul>
                @for (layer of savedLayers(); track layer.id) {
                  <li>{{ layer.type | titlecase }} ({{ layer.param_value }})</li>
                }
              </ul>
            </div>
          }
        }
      </div>
    </div>
  }

</div>

