<div class="capture-container">

  <!-- Messages -->
  @if (error()) {
    <div class="message-banner error">{{ error() }}</div>
  }
  @if (successMessage()) {
    <div class="message-banner success">{{ successMessage() }}</div>
  }

  <canvas #canvasEl class="hidden"></canvas>

  <!-- ========== CAPTURE MODE ========== -->
  @if (mode() === 'capture') {
    <div class="media-frame camera-frame">
      @if (!cameraActive()) {
        <p class="placeholder-text">Camera preview will appear here</p>
      }
      <video #videoEl [class.hidden]="!cameraActive()" autoplay playsinline muted></video>

      <!-- Camera controls overlay - only show if capabilities exist -->
      @if (cameraActive() && (cameraCapabilities().brightness || cameraCapabilities().zoom)) {
        <div class="camera-controls">
          @if (cameraCapabilities().brightness) {
            <div class="control-group">
              <button class="control-btn" (click)="adjustBrightness(-1)" title="Darker">âˆ’</button>
              <span class="control-icon">ğŸ”†</span>
              <button class="control-btn" (click)="adjustBrightness(1)" title="Brighter">+</button>
            </div>
          }
          @if (cameraCapabilities().zoom) {
            <div class="control-group">
              <button class="control-btn" (click)="adjustZoom(-1)" title="Zoom out">âˆ’</button>
              <span class="control-icon">ğŸ”</span>
              <button class="control-btn" (click)="adjustZoom(1)" title="Zoom in">+</button>
            </div>
          }
        </div>
      }
    </div>

    <div class="controls">
      @if (!cameraActive()) {
        <button class="btn btn-primary btn-lg" (click)="startCamera()">Start Camera</button>
      } @else {
        <button class="btn btn-primary" (click)="capture()" [disabled]="processing()">ğŸ“· Capture</button>
        <button class="btn btn-secondary" (click)="stopCamera()">Stop</button>
      }
    </div>
  }

  <!-- ========== EDIT MODE (after capture) ========== -->
  @if (mode() === 'edit') {
    <div class="edit-panel">
      <div class="media-frame">
        <img [src]="rawImageUrl()" alt="Captured image" />
      </div>

      <!-- Title input -->
      <div class="title-input">
        <label for="imageTitle">Title</label>
        <input
          id="imageTitle"
          type="text"
          [ngModel]="imageTitle()"
          (ngModelChange)="imageTitle.set($event)"
          placeholder="Enter image title..."
          [disabled]="isImageSaved()" />
      </div>

      <!-- Category picker -->
      @if (!isImageSaved()) {
        <div class="category-input">
          <label>Category</label>
          <app-category-picker
            [selectedId]="selectedCategory()"
            (selectedChange)="selectedCategory.set($event)" />
        </div>

        <div class="action-row">
          <button class="btn btn-primary" (click)="saveRawImage()" [disabled]="processing()">
            @if (processing()) {
              <span class="spinner"></span> Saving...
            } @else {
              Save to Gallery
            }
          </button>
          <button class="btn btn-danger" (click)="discard()">Discard</button>
        </div>
      } @else {
        <div class="saved-status">
          âœ“ Saved: {{ savedImage()?.title }}
        </div>
        <div class="action-row">
          <button class="btn btn-primary" (click)="goToLayerEditor()">Edit Layers</button>
          <button class="btn btn-secondary" (click)="discard()">New Capture</button>
        </div>
      }
    </div>
  }

</div>

